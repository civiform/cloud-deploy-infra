#! /usr/bin/env bash
#
# The purpose of this script is to dynamically enable python packages.
# The current main use case is the usage of the env-var-docs parser, which is defined
# in the civiform repository.

# Initializes a python virtual environment(venv) and installs required dependencies.
# Takes an argument that specifies the path to the requirements.txt file,
# which contains a list of python packages to be installed in the venv.
# For more details about requirement files see:
# https://pip.pypa.io/en/stable/user_guide/#requirements-files
function initialize_python_env() {
    

# # Use config parser to get the version
# # If version below a certain value, use first json that existed.

# # Define the tag to search for
# tag="v1.0.0"

# # Define the GitHub API URL
# url="https://api.github.com/repos/civiform/civiform/git/refs/tags/${tag}"

# # Make a request to the GitHub API
# response=$(curl -s "${url}")

# # Check if the response is valid
# if [[ "${response}" == *"\"message\":"* ]]; then
#   # Print the error message
#   message=$(echo "${response}" | jq -r .message)
#   echo "Error: The commit sha for version ${tag} could not be found: ${message}"
#   exit 1
# else
#   # Parse the response and extract the commit SHA
#   commit_sha=$(echo "${response}" | jq -r .object.sha)
#   echo "${commit_sha}"
#   exit 0
# fi
  
#   local env_var_docs_package = git+https://github.com/civiform/civiform.git@3af899747eee36c2cd05892a0067dd5843b923f3#subdirectory=env-var-docs/parser-package
#   local requests_package = "requests"

  echo "initializing python env from script"

  local requirements_file_path=$1

  # Check if there are any requirements to install
  if [[ ! -f "$requirements_file_path" ]]; then
    echo "Requirements file $requirements_file_path does not exist, python setup skipped"
    return
  fi

  # Create a virtual environment if it doesn't exist yet
  if [[ ! -d .venv ]]; then
    echo ".venv directory not found, creating and installing dependencies..."
    python3 -m venv .venv
  fi

  # source the activate script (. is more portable between shells than source)
  . .venv/bin/activate

  #Check if the requirement file is already met.
  if [[ ! $(pip3 freeze | diff "$requirements_file_path" -) ]]; then
    echo ".venv directory found with necessary dependencies installed"
    return
  else
    echo "installing python dependencies in .venv ..."
    pip3 install -r "$requirements_file_path"
    return
  fi
}

# Remove the python virtual environment. This will also remove all python
# packages that were previously installed in the environment.
function remove_python_env() {
  if [[ -d .venv ]]; then
    echo "Deactivating and removing python virtual environment and dependencies intalled inside it by removing .env folder"
    deactivate
    rm -r .venv
  else
    echo "No .env folder found, skipping removal of Python virtual environment."
  fi
}
